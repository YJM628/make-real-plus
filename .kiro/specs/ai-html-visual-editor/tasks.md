# 实现计划：AI 驱动的 HTML 可视化编辑器

## 概述

本实现计划将 AI 驱动的 HTML 可视化编辑器分解为可执行的编码任务。该系统基于 React 和 tldraw 构建，使用 TypeScript 实现。实现将采用增量方式，从核心基础设施开始，逐步添加功能，并在每个阶段进行测试验证。

## 任务

- [x] 1. 项目初始化和核心基础设施
  - 创建 React + TypeScript + tldraw 项目结构
  - 配置 ESLint、Prettier、TypeScript
  - 设置测试框架（Jest + fast-check）
  - 定义核心 TypeScript 类型和接口（HtmlShapeProps, ElementOverride, HtmlParseResult, ParsedElement, SyncState, ViewportConfig, AIGenerationContext）
  - _需求：所有需求的基础_

- [x] 2. 实现数据模型和工具函数
  - [x] 2.1 创建核心数据类型定义
    - 定义 ElementOverride 接口（selector, text, styles, html, attributes, position, size, timestamp, aiGenerated, original）
    - 定义 HtmlParseResult 和 ParsedElement 接口
    - 定义 SyncState 接口
    - 定义 ViewportConfig 类型
    - 定义 AIGenerationContext 接口
    - _需求：9.2, 11.1_
  
  - [x] 2.2 实现 CSS 选择器工具函数
    - 实现 generateCssSelector()：为元素生成唯一 CSS 选择器
    - 实现 validateSelector()：验证选择器唯一性
    - 实现 findElement()：通过选择器查找元素，带位置回退
    - 实现 generatePositionBasedSelector()：基于位置的回退选择器
    - _需求：5.3, 5.5_
  
  - [x] 2.3 实现样式处理工具函数
    - 实现 parseCssString()：解析 CSS 字符串为对象
    - 实现 styleToCssString()：对象转 CSS 字符串
    - 实现 mergeStyles()：合并多个样式对象
    - 实现 getComputedStyles()：提取计算样式
    - 实现 applyStyles()：应用样式到元素
    - 实现 getPositioningType()：检测定位类型
    - 实现 adjustPositioningForDrag()：调整拖动定位策略
    - _需求：6.2, 6.4, 6.7_
  
  - [x] 2.4 实现性能优化工具函数
    - 实现 debounce()：防抖函数
    - 实现 throttle()：节流函数
    - 实现 isInViewport()：检查元素是否在视口内
    - _需求：20.4, 20.5_

  - [ ]* 2.5 编写选择器工具的属性测试
    - **属性 10：CSS 选择器唯一性** - 生成的选择器应唯一匹配元素
    - **验证：需求 5.3**

- [x] 3. 实现 HTML 解析器
  - [x] 3.1 创建 HtmlParser 类
    - 实现 parse()：使用 DOMParser 解析 HTML 字符串
    - 实现 buildElementTree()：递归构建 ParsedElement 树
    - 实现 extractIdentifiers()：提取或生成唯一标识符（id 或 data-uuid）
    - 实现 generateIdentifier()：生成唯一标识符
    - 实现 generateSelector()：为元素生成 CSS 选择器
    - 实现 extractStyles()：提取内联和计算样式
    - 实现 validate()：验证 HTML 语法
    - 实现 extractExternalResources()：提取外部资源链接
    - 实现 injectIdentifiers()：为导入的 HTML 注入标识符
    - _需求：11.1, 11.2, 11.3, 11.4, 11.5, 16.5_
  
  - [ ]* 3.2 编写 HTML 解析器的属性测试
    - **属性 5：HTML 解析往返** - 解析然后序列化应保留标识符和结构
    - **属性 18：HTML 解析完整性** - 解析应提取所有元素信息
    - **属性 19：无效 HTML 错误处理** - 无效输入应返回错误而非异常
    - **验证：需求 11.1, 11.2, 11.3**
  
  - [ ]* 3.3 编写 HTML 解析器的单元测试
    - 测试空 HTML 输入
    - 测试嵌套元素解析
    - 测试特殊字符和编码处理
    - 测试缺失标签自动补全
    - _需求：11.1, 11.3_

- [x] 4. 实现覆盖存储系统
  - [x] 4.1 创建 OverrideStore 类
    - 实现 addOverride()：添加新覆盖
    - 实现 mergeOverrides()：合并同一元素的多个覆盖（按时间戳）
    - 实现 getOverridesBySelector()：按选择器查询覆盖
    - 实现 removeOverride()：移除指定覆盖
    - 实现 getAllOverrides()：获取所有覆盖
    - 实现 clearOverrides()：清除所有覆盖
    - _需求：9.1, 9.2, 9.3_
  
  - [ ]* 4.2 编写覆盖系统的属性测试
    - **属性 15：覆盖合并幂等性** - 合并覆盖应该是幂等的
    - **属性 16：覆盖应用顺序** - 按时间戳应用应产生一致结果
    - **验证：需求 9.3, 9.4**
  
  - [ ]* 4.3 编写覆盖系统的单元测试
    - 测试同一元素的多次修改合并
    - 测试覆盖的添加和移除
    - _需求：9.3_

- [x] 5. 实现同步引擎
  - [x] 5.1 创建 SyncEngine 类
    - 实现 initSync()：为新 HTML 形状初始化同步状态
    - 实现 applyOverride()：应用覆盖到形状和 DOM
    - 实现 syncShapeToDOM()：形状位置/尺寸变化同步到 DOM
    - 实现 syncDOMToShape()：DOM 内容/样式变化同步到形状
    - 实现 getSyncState()：获取当前同步状态
    - 实现 validateSync()：验证同步一致性
    - 实现 recoverSync()：从同步错误中恢复
    - 实现 addHistoryEntry()：添加历史记录条目
    - 实现 restoreToVersion()：恢复到历史版本
    - _需求：10.1, 10.2, 10.3, 10.4, 10.5, 19.1, 19.5_
  
  - [ ]* 5.2 编写同步引擎的属性测试
    - **属性 17：双向同步一致性** - 形状和 DOM 应保持一致
    - **验证：需求 10.1, 10.2, 10.3**
  
  - [ ]* 5.3 编写同步引擎的单元测试
    - 测试同步失败恢复机制
    - 测试循环依赖检测
    - 测试冲突解决（时间戳优先级）
    - _需求：10.5_

- [x] 6. 检查点 - 核心引擎验证
  - 确保所有测试通过，如有问题请询问用户。

- [x] 7. 实现差异引擎
  - [x] 7.1 创建 DiffEngine 类
    - 实现 calculateDiff()：计算原始和修改后 HTML 的差异
    - 实现 applyOverrides()：将覆盖应用到 HTML 字符串
    - 实现 mergeOverrides()：合并覆盖列表
    - 实现 generateExport()：生成可导出的 HTML（单文件或分离格式）
    - 实现 generateMediaQueries()：生成响应式媒体查询
    - _需求：12.1, 12.2, 12.3, 12.5, 18.4, 18.6_
  
  - [ ]* 7.2 编写差异引擎的属性测试
    - **属性 20：导出往返一致性** - 无修改时导出应匹配原始
    - **属性 21：差异计算完整性** - 差异应包含所有修改
    - **验证：需求 12.1, 12.2, 12.4**
  
  - [ ]* 7.3 编写差异引擎的单元测试
    - 测试单文件导出格式
    - 测试分离文件导出格式（HTML/CSS/JS）
    - 测试空覆盖导出
    - _需求：12.4, 12.5_

- [x] 8. 实现 AI 服务集成
  - [x] 8.1 创建 AIService 接口和实现
    - 定义 AIService 接口（generateHtml, optimizeElement, generateBatch, validateResponse）
    - 实现流式 generateHtml()：从自然语言生成 HTML/CSS/JS
    - 实现 optimizeElement()：优化单个元素
    - 实现 generateBatch()：批量生成多个页面
    - 实现 validateResponse()：验证 AI 响应有效性
    - 实现超时处理（10 秒显示进度，30 秒超时）
    - 实现错误处理和重试机制
    - 实现流式中断恢复
    - _需求：1.1, 1.2, 1.6, 1.8, 3.1, 7.5, 7.6, 8.5, 8.6_
  
  - [x] 8.2 创建 useAI React Hook
    - 实现 generate()：调用 AI 生成并处理流式响应
    - 实现 optimize()：调用 AI 优化元素
    - 管理 loading 和 error 状态
    - 处理流式数据接收和实时更新
    - _需求：1.2, 1.3, 7.5_
  
  - [x] 8.3 实现设计系统集成
    - 创建 Material UI 适配器
    - 创建 Ant Design 适配器
    - 创建 Tailwind CSS 适配器
    - 在 AI 提示中包含设计系统信息
    - 验证生成代码使用正确的组件语法
    - _需求：1.5, 1.7, 13.1, 13.2, 13.3, 13.4_
  
  - [ ]* 8.4 编写 AI 服务的属性测试
    - **属性 1：AI 生成有效性** - 生成的 HTML/CSS/JS 应该有效且可解析
    - **属性 2：流式生成完整性** - 流式 chunk 组合应等于完整结果
    - **属性 3：元素标识符唯一性** - 关键交互元素应有唯一标识符
    - **验证：需求 1.1, 1.2, 1.3, 1.4**
  
  - [ ]* 8.5 编写 AI 服务的单元测试
    - 测试超时处理和进度显示
    - 测试网络错误恢复
    - 测试流式中断恢复
    - 测试无效响应处理
    - _需求：1.6, 1.8, 14.1_

- [x] 9. 实现 HybridHtmlShapeUtil（tldraw 自定义形状）
  - [x] 9.1 创建自定义 tldraw 形状
    - 定义 HtmlShapeProps 接口（id, type, x, y, width, height, props）
    - 实现 HybridHtmlShapeUtil 类继承 ShapeUtil
    - 实现 component()：根据模式（preview/edit/split）渲染形状
    - 实现 onResize()：处理形状调整大小并同步到 HTML
    - 实现 onRotate()：处理形状旋转
    - 实现 indicator()：显示选中指示器
    - 实现 onPointerDown/Move/Up()：处理形状交互
    - _需求：2.1, 2.2, 2.4, 2.5_
  
  - [ ]* 9.2 编写形状工具的属性测试
    - **属性 4：形状创建一致性** - 形状数量应匹配顶层 HTML 元素
    - **属性 6：形状尺寸同步** - 调整大小应同步更新 HTML 容器尺寸
    - **验证：需求 2.1, 2.5**
  
  - [ ]* 9.3 编写形状工具的单元测试
    - 测试形状创建和初始化
    - 测试形状变换（移动、调整大小、旋转）
    - _需求：2.4_

- [x] 10. 实现渲染模式组件
  - [x] 10.1 实现 PreviewMode 组件
    - 创建 iframe 容器
    - 实现 HTML/CSS/JS 注入到 iframe（使用 srcdoc）
    - 在渲染前应用覆盖到 HTML
    - 实现 iframe 通信（postMessage）
    - 支持完整的用户交互（按钮点击、表单输入、事件触发）
    - 保持页面状态（表单输入、滚动位置）
    - _需求：4.4, 4.5, 4.9_
  
  - [x] 10.2 实现 EditMode 组件
    - 创建 Shadow DOM 容器
    - 渲染带覆盖的 HTML
    - 实现元素点击选择功能
    - 实现元素高亮显示（蓝色边框）
    - 生成选中元素的 CSS 选择器
    - 实现元素拖动功能（实时更新位置）
    - 实现元素缩放功能（拖动边框控制点）
    - 显示实时尺寸和位置提示
    - 处理 flex/grid 布局约束（智能调整定位策略）
    - _需求：4.6, 5.1, 5.2, 5.4, 6.1, 6.2, 6.3, 6.4, 6.5, 6.7_
  
  - [x] 10.3 实现 SplitMode 组件
    - 创建左右分栏布局
    - 左侧渲染原始 HTML（使用 PreviewMode）
    - 右侧渲染修改后 HTML（使用 PreviewMode）
    - 实现同步滚动
    - _需求：4.7_
  
  - [ ]* 10.4 编写渲染模式的属性测试
    - **属性 9：模式切换状态保持** - 切换模式应保留所有覆盖和选中状态
    - **验证：需求 4.8**
  
  - [ ]* 10.5 编写 EditMode 的单元测试
    - 测试元素选择事件处理
    - 测试拖动边界检查
    - 测试缩放最小尺寸限制
    - 测试点击外部取消选择
    - _需求：5.1, 5.4, 6.1, 6.3_

- [x] 11. 实现浮动编辑面板
  - [x] 11.1 创建 FloatingEditPanel 组件
    - 实现三标签界面（内容/样式/AI）
    - 内容标签：文本输入框，实时更新元素文本
    - 样式标签：颜色选择器、尺寸输入、间距控制
    - AI 标签：自然语言输入框，调用 AI 优化
    - 实现保存和取消按钮
    - 实现实时预览功能
    - 关闭时创建 Element_Override
    - _需求：7.1, 7.2, 7.3, 7.4, 7.5, 7.7, 7.8_
  
  - [ ]* 11.2 编写编辑面板的属性测试
    - **属性 13：文本编辑同步** - 文本修改应立即反映在 DOM 并创建覆盖
    - **验证：需求 7.3, 7.8**
  
  - [ ]* 11.3 编写编辑面板的单元测试
    - 测试面板显示和隐藏
    - 测试标签切换
    - 测试保存和取消操作
    - _需求：7.1, 7.8_

- [x] 12. 检查点 - UI 组件验证
  - 确保所有测试通过，如有问题请询问用户。

- [x] 13. 实现截图圈选工具
  - [x] 13.1 创建 ScreenshotSelector 组件
    - 实现半透明遮罩覆盖
    - 实现矩形选区拖动绘制
    - 使用 html2canvas 或类似库捕获选区截图
    - 识别选区内的所有 HTML 元素（边界框相交检测）
    - 返回截图 Blob 和元素列表
    - _需求：8.1, 8.2, 8.3, 8.4_
  
  - [x] 13.2 集成截图到 AI 优化流程
    - 将截图和选区内元素结构发送给 AI
    - 实时预览 AI 修改效果
    - 用户确认后应用修改为 Element_Override
    - 支持取消圈选操作
    - _需求：8.5, 8.6, 8.7, 8.8, 8.9_
  
  - [ ]* 13.3 编写截图工具的属性测试
    - **属性 14：截图元素识别完整性** - 应识别所有边界框与选区相交的元素
    - **验证：需求 8.4**
  
  - [ ]* 13.4 编写截图工具的单元测试
    - 测试选区绘制
    - 测试截图捕获
    - 测试元素识别
    - _需求：8.2, 8.3, 8.4_

- [x] 14. 实现批量生成和自动布局
  - [x] 14.1 实现批量生成逻辑
    - 解析用户请求识别页面数量和类型
    - 调用 AI 批量生成接口
    - 为每个生成的页面创建独立的 HTML_Shape
    - _需求：3.1, 3.2, 3.6_
  
  - [x] 14.2 实现自动布局算法
    - 计算形状位置（从左到右排列）
    - 保持形状之间 50px 间距
    - 按逻辑顺序排列（如首页、详情页）
    - 自动调整画布视图以显示所有生成的形状
    - _需求：3.3, 3.4, 3.5, 3.7_
  
  - [ ]* 14.3 编写批量生成的属性测试
    - **属性 7：批量生成数量一致性** - 应生成指定数量的有效页面
    - **属性 8：自动布局间距** - 相邻形状间距应一致
    - **验证：需求 3.1, 3.2, 3.3**
  
  - [ ]* 14.4 编写批量生成的单元测试
    - 测试页面数量解析
    - 测试自动布局计算
    - 测试画布视图调整
    - _需求：3.6, 3.7_

- [x] 15. 实现工具栏和模式切换
  - [x] 15.1 创建 Toolbar 组件
    - 实现生成按钮（打开 AI 输入对话框）
    - 实现导入按钮（上传 HTML 文件）
    - 实现导出按钮（触发代码导出）
    - 实现模式切换按钮（预览 P / 编辑 E / 对比 S）
    - 实现设备预览选择器（桌面/平板/手机/自定义）
    - 实现截图圈选工具按钮
    - 实现查看代码按钮
    - 实现历史记录按钮
    - 显示当前激活模式的视觉高亮
    - _需求：15.3, 4.1, 4.2, 4.3, 4.10, 18.1_
  
  - [x] 15.2 实现键盘快捷键
    - 绑定 P 键切换预览模式
    - 绑定 E 键切换编辑模式
    - 绑定 S 键切换对比模式
    - 实现其他常用操作的快捷键
    - _需求：4.1, 4.2, 4.3_
  
  - [ ]* 15.3 编写工具栏的单元测试
    - 测试按钮点击事件
    - 测试键盘快捷键
    - 测试模式高亮状态
    - _需求：4.10, 15.3_

- [x] 16. 实现导入功能
  - [x] 16.1 创建 HTML 导入功能
    - 实现文件选择对话框
    - 读取和解析 HTML 文件内容
    - 检测外部 CSS 链接并提示用户是否加载
    - 检测外部 JavaScript 并提示安全风险
    - 为缺少标识符的关键元素自动注入 data-uuid
    - 创建 HTML_Shape 并添加到画布
    - 支持导入多个文件并自动排列
    - _需求：16.1, 16.2, 16.3, 16.4, 16.5, 16.6_
  
  - [ ]* 16.2 编写导入功能的属性测试
    - **属性 22：导入标识符注入** - 应自动生成缺失的标识符
    - **验证：需求 16.5**
  
  - [ ]* 16.3 编写导入功能的单元测试
    - 测试多文件导入
    - 测试外部资源警告
    - 测试标识符注入
    - _需求：16.3, 16.4, 16.5, 16.6_

- [x] 17. 实现代码编辑器
  - [x] 17.1 创建 CodeEditor 组件
    - 集成 Monaco Editor 或 CodeMirror
    - 实现 HTML/CSS/JS 标签页界面
    - 实现语法高亮
    - 实现实时语法验证
    - 实现错误高亮显示
    - 实现代码格式化功能
    - 实现自动补全支持
    - _需求：17.1, 17.2, 17.3, 17.4, 17.6, 17.7_
  
  - [x] 17.2 实现代码保存和同步
    - 保存时重新解析 HTML
    - 更新 HTML_Shape 属性
    - 验证代码有效性
    - 显示语法错误
    - _需求：17.4, 17.5, 17.6_
  
  - [ ]* 17.3 编写代码编辑器的属性测试
    - **属性 23：代码编辑往返** - 编辑保存应正确更新形状
    - **验证：需求 17.5**
  
  - [ ]* 17.4 编写代码编辑器的单元测试
    - 测试语法错误检测
    - 测试代码格式化
    - 测试自动补全
    - _需求：17.4, 17.6, 17.7_

- [x] 18. 实现响应式设计支持
  - [x] 18.1 创建视口配置系统
    - 定义预设视口（desktop: 1920x1080, tablet: 768x1024, mobile: 375x667）
    - 实现自定义视口尺寸输入
    - 实现视口切换逻辑
    - 显示当前视口尺寸
    - _需求：18.1, 18.3, 18.5_
  
  - [x] 18.2 实现响应式调整和媒体查询
    - 切换视口时调整 HTML_Shape 宽度
    - 在不同设备模式下修改样式时生成媒体查询
    - 在导出时包含所有响应式媒体查询
    - _需求：18.2, 18.4, 18.6_
  
  - [ ]* 18.3 编写响应式功能的属性测试
    - **属性 24：响应式视口调整** - 切换视口应调整形状尺寸并可恢复
    - **验证：需求 18.2**
  
  - [ ]* 18.4 编写响应式功能的单元测试
    - 测试预设视口切换
    - 测试自定义视口输入
    - 测试媒体查询生成
    - _需求：18.1, 18.4, 18.5_

- [x] 19. 实现历史记录和版本管理
  - [x] 19.1 创建 HistoryPanel 组件
    - 实现时间线视图显示所有修改
    - 显示每个条目的时间、类型、内容、AI 生成标志
    - 实现点击预览历史版本
    - 实现恢复到选定版本（移除后续覆盖）
    - 实现版本比较功能（显示差异）
    - 实现为版本添加标签和注释
    - _需求：19.1, 19.2, 19.3, 19.4, 19.5, 19.6, 19.7_
  
  - [x] 19.2 集成历史记录到同步引擎
    - 每次应用覆盖时添加历史条目
    - 实现版本恢复逻辑（调用 SyncEngine.restoreToVersion）
    - _需求：19.1, 19.5_
  
  - [ ]* 19.3 编写历史记录的属性测试
    - **属性 25：历史记录完整性** - 应包含所有覆盖并按时间排序
    - **属性 26：版本恢复正确性** - 恢复应移除时间戳大于目标的覆盖
    - **验证：需求 19.2, 19.5**
  
  - [ ]* 19.4 编写历史记录的单元测试
    - 测试历史条目添加
    - 测试版本预览
    - 测试版本恢复
    - 测试版本比较
    - _需求：19.3, 19.4, 19.7_

- [x] 20. 检查点 - 高级功能验证
  - 确保所有测试通过，如有问题请询问用户。

- [x] 21. 实现画布交互和 AI 输入对话框
  - [x] 21.1 实现双击创建功能
    - 监听画布空白区域双击事件
    - 显示 AI 输入对话框
    - 处理用户输入（自然语言描述）
    - 调用 AI 生成 HTML
    - 在双击位置创建 HTML_Shape
    - _需求：15.1, 15.2_
  
  - [x] 21.2 实现撤销/重做功能
    - 集成 tldraw 的撤销/重做系统
    - 支持所有 HTML_Shape 操作的撤销/重做
    - _需求：15.5_
  
  - [ ]* 21.3 编写画布交互的单元测试
    - 测试双击事件处理
    - 测试 AI 对话框显示和隐藏
    - 测试撤销/重做功能
    - _需求：15.1, 15.2, 15.5_

- [x] 22. 实现元素拖动和缩放的覆盖记录
  - [x] 22.1 集成拖动到覆盖系统
    - 拖动完成时创建位置覆盖（position 字段）
    - 更新元素的 CSS 定位属性（left, top 或 transform）
    - 处理 flex/grid 布局约束（转换为 absolute 定位）
    - 保留原始位置用于恢复
    - _需求：6.1, 6.2, 6.6, 6.7_
  
  - [x] 22.2 集成缩放到覆盖系统
    - 缩放完成时创建尺寸覆盖（size 字段）
    - 更新元素的 CSS 尺寸属性（width, height）
    - 保留原始尺寸用于恢复
    - _需求：6.3, 6.4, 6.6_
  
  - [ ]* 22.3 编写拖动缩放的属性测试
    - **属性 11：元素拖动位置更新** - 拖动应创建正确的位置覆盖
    - **属性 12：元素缩放尺寸更新** - 缩放应创建正确的尺寸覆盖
    - **验证：需求 6.1, 6.2, 6.3, 6.4, 6.6**
  
  - [ ]* 22.4 编写拖动缩放的单元测试
    - 测试拖动位置计算
    - 测试缩放尺寸计算
    - 测试布局约束处理
    - _需求：6.7_

- [x] 23. 实现性能优化
  - [x] 23.1 实现视口裁剪渲染
    - 检测 HTML_Shape 是否在画布视口内
    - 只渲染可见的形状
    - 形状进出视口时动态加载/卸载
    - _需求：20.4_
  
  - [x] 23.2 实现防抖和节流
    - 对拖动操作应用节流（提高性能）
    - 对缩放操作应用节流
    - 对输入事件应用防抖
    - _需求：20.5_
  
  - [x] 23.3 实现延迟加载和性能监控
    - 延迟加载外部图片
    - 延迟加载外部字体
    - 延迟加载外部样式表
    - 监控内存使用（超过 500MB 时警告）
    - 监控渲染帧率（低于 30fps 时启用性能模式）
    - 大文件警告（HTML 超过 100KB）
    - _需求：20.2, 20.3, 20.6, 20.7_
  
  - [ ]* 23.4 编写性能优化的属性测试
    - **属性 27：视口裁剪优化** - 只渲染视口内可见的形状
    - **验证：需求 20.4**
  
  - [ ]* 23.5 编写性能监控的单元测试
    - 测试内存使用监控
    - 测试性能警告触发
    - 测试帧率监控
    - _需求：20.1, 20.2, 20.3, 20.7_

- [x] 24. 实现错误处理和验证
  - [x] 24.1 实现 AI 错误处理
    - 超时错误显示和重试（30 秒超时）
    - 无效响应处理（显示验证错误）
    - 网络错误恢复（保存状态，提供离线模式）
    - 流式中断恢复（保留部分内容，允许重试）
    - _需求：14.1, 1.8_
  
  - [x] 24.2 实现解析错误处理
    - 语法错误显示（具体位置和描述）
    - 自动修复建议
    - 缺失标签自动补全
    - 编码问题自动检测和转换
    - _需求：14.2_
  
  - [x] 24.3 实现同步错误处理
    - 冲突检测和解决（时间戳优先级）
    - 循环依赖检测和打破
    - 内存泄漏清理（定期清理未使用状态）
    - 错误恢复机制（回退到最后有效状态）
    - _需求：14.3_
  
  - [x] 24.4 实现输入验证
    - 验证所有用户输入
    - 验证 AI 响应
    - 生成无效选择器时回退到基于位置的选择器
    - _需求：14.4, 14.5_
  
  - [ ]* 24.5 编写错误处理的单元测试
    - 测试各种错误场景
    - 测试错误恢复机制
    - 测试用户友好的错误消息
    - 测试输入验证
    - _需求：14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 25. 实现安全性措施
  - [x] 25.1 实现 XSS 防护
    - 在 iframe 中使用 sandbox 属性渲染用户生成的 HTML
    - 实施严格的内容安全策略（CSP）
    - 验证所有用户输入
    - 清理和验证 AI 响应
    - _需求：所有涉及用户输入和 AI 生成的需求_
  
  - [x] 25.2 实现外部资源安全
    - 警告用户加载外部脚本的风险
    - 警告用户加载外部样式的风险
    - 提供资源白名单选项
    - _需求：16.3, 16.4_
  
  - [ ]* 25.3 编写安全性的单元测试
    - 测试 XSS 攻击防护
    - 测试恶意脚本拦截
    - 测试 CSP 策略执行
    - 测试外部资源警告
    - _需求：安全性相关_

- [x] 26. 实现可访问性支持
  - [x] 26.1 添加键盘导航
    - 为所有功能添加键盘快捷键
    - 实现逻辑的 Tab 顺序
    - 添加清晰的焦点指示器
    - _需求：可访问性_
  
  - [x] 26.2 添加 ARIA 标签和屏幕阅读器支持
    - 为所有交互元素添加 ARIA 标签
    - 为动态内容添加 aria-live 区域
    - 确保 UI 元素满足 WCAG AA 对比度标准
    - _需求：可访问性_
  
  - [ ]* 26.3 编写可访问性的单元测试
    - 测试键盘导航
    - 测试屏幕阅读器兼容性
    - 测试对比度要求
    - _需求：可访问性_

- [x] 27. 集成和端到端测试
  - [x] 27.1 编写端到端测试
    - 测试完整的生成到导出流程
    - 测试批量生成流程
    - 测试编辑和修改流程（选择、拖动、缩放、编辑面板）
    - 测试截图圈选和 AI 优化流程
    - 测试导入和编辑流程
    - 测试模式切换流程
    - 测试响应式设计流程
    - 测试历史记录和版本恢复流程
    - _需求：所有主要用户流程_
  
  - [ ]* 27.2 编写集成测试
    - 测试组件之间的交互
    - 测试同步引擎与 UI 的集成
    - 测试 AI 服务与编辑器的集成
    - 测试覆盖系统与渲染模式的集成
    - 测试历史记录与同步引擎的集成
    - _需求：所有需求_

- [x] 28. 最终检查点和验证
  - [x] 28.1 确保所有测试通过
    - 运行所有单元测试
    - 运行所有属性测试（100+ 迭代）
    - 运行所有集成测试
    - 运行所有端到端测试
    - 确保测试覆盖率 > 80%
  
  - [x] 28.2 性能验证
    - 验证 60fps 渲染（< 10 个形状）
    - 验证内存使用 < 500MB
    - 验证 AI 响应时间显示进度（> 10 秒）
    - 验证大文件警告（> 100KB）
  
  - [x] 28.3 浏览器兼容性测试
    - 在 Chrome 90+ 中测试
    - 在 Firefox 88+ 中测试
    - 在 Safari 14+ 中测试
    - 在 Edge 90+ 中测试
    - 验证必要的 polyfills
  
  - [x] 28.4 创建用户文档
    - 编写 README.md（项目介绍、安装、使用）
    - 编写使用指南（功能说明、操作步骤）
    - 编写 API 文档（组件接口、工具函数）
    - 创建示例和教程

- [x] 29. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

## 注意事项

### 测试要求

- 所有标记为 `*` 的子任务是可选的，可以跳过以加快 MVP 开发
- 每个属性测试必须使用 fast-check 库运行至少 100 次迭代
- 每个属性测试必须在注释中引用设计文档中的属性编号
- 标签格式：`Feature: ai-html-visual-editor, Property {number}: {property_text}`
- 单元测试应专注于特定示例、边缘情况和错误条件
- 属性测试应验证通用正确性属性

### 实现顺序

- 任务按照依赖顺序排列
- 核心基础设施和引擎（任务 1-7）必须首先完成
- AI 服务和 tldraw 集成（任务 8-9）依赖于核心引擎
- UI 组件（任务 10-12）依赖于形状工具和引擎
- 高级功能（任务 13-20）依赖于 UI 组件
- 画布交互和优化（任务 21-26）在核心功能完成后实现
- 集成测试和验证（任务 27-29）在最后完成

### 检查点

- 在任务 6、12、20、29 设置检查点
- 每个检查点确保所有测试通过
- 如有问题，询问用户后再继续

### 需求追溯

- 每个任务都标注了它实现的需求编号
- 使用 `_需求：X.Y, X.Z_` 格式
- 确保所有 20 个需求的验收标准都被至少一个任务覆盖

### 双重测试方法

- 单元测试和属性测试是互补的，都是必需的
- 单元测试：验证特定示例、边缘情况、错误条件
- 属性测试：验证所有输入的通用属性
- 避免编写过多单元测试 - 属性测试处理大量输入覆盖
